<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN ÌòëÏóÖ Ìé∏ÏßëÍ∏∞</title>
    
    <!-- BPMN.js Ïä§ÌÉÄÏùº -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.2.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.2.1/dist/assets/bpmn-font/css/bpmn-embedded.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .toolbar h1 {
            font-size: 18px;
            color: #333;
            margin-right: 20px;
        }
        
        .toolbar button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .toolbar button:hover {
            background: #f5f5f5;
            border-color: #007bff;
        }
        
        .toolbar button.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .toolbar button.primary:hover {
            background: #0056b3;
        }
        
        .toolbar .status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-indicator.connected {
            background: #28a745;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: white;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            background: #fafafa;
        }
        
        /* BPMN.js Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .djs-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        .properties-panel {
            width: 300px;
            background: white;
            border-left: 1px solid #ddd;
            display: none;
        }
        
        .properties-panel.show {
            display: block;
        }
        
        #properties-panel {
            height: 100%;
            overflow-y: auto;
            padding: 15px;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }
        
        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
        }
        
        .success-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        /* BPMN.js Ïä§ÌÉÄÏùº Ïò§Î≤ÑÎùºÏù¥Îìú */
        .djs-palette {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .djs-context-pad {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .properties-panel {
                width: 250px;
            }
            
            .toolbar h1 {
                display: none;
            }
            
            .toolbar {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <!-- Ìà¥Î∞î -->
            <div class="toolbar">
                <h1>ü§ù BPMN ÌòëÏóÖ Ìé∏ÏßëÍ∏∞</h1>
                
                <button id="new-diagram">ÏÉà Îã§Ïù¥Ïñ¥Í∑∏Îû®</button>
                <button id="load-diagram">Î∂àÎü¨Ïò§Í∏∞</button>
                <button id="save-diagram">Ï†ÄÏû•</button>
                <button id="export-svg">SVG ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                
                <div style="border-left: 1px solid #ddd; height: 20px; margin: 0 10px;"></div>
                
                <button id="start-collaboration" class="primary">ÌòëÏóÖ ÏãúÏûë</button>
                <button id="stop-collaboration" style="display: none;">ÌòëÏóÖ Ï§ëÏßÄ</button>
                
                <button id="toggle-properties">ÏÜçÏÑ± Ìå®ÎÑê</button>
                
                <div class="status">
                    <span id="status-text">Ïó∞Í≤∞ ÏïàÎê®</span>
                    <div id="status-indicator" class="status-indicator"></div>
                </div>
            </div>
            
            <!-- Î©îÏù∏ Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ -->
            <div class="canvas-container">
                <div id="canvas"></div>
            </div>
        </div>
        
        <!-- ÏÜçÏÑ± Ìå®ÎÑê -->
        <div id="properties-panel-container" class="properties-panel">
            <div id="properties-panel"></div>
        </div>
    </div>
    
    <!-- Î°úÎî© Ïä§ÌîºÎÑà -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
    <div id="error-message" class="error-message"></div>
    
    <!-- ÏÑ±Í≥µ Î©îÏãúÏßÄ -->
    <div id="success-message" class="success-message"></div>
    
    <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
        // BpmnCollaborationEditorÎäî WebpackÏóê ÏùòÌï¥ Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂úÎê©ÎãàÎã§
        
        class AppController {
            constructor() {
                this.editor = null;
                this.documentId = this.generateDocumentId();
                this.userId = this.generateUserId();
                this.userName = this.generateUserName();
                this.isCollaborating = false;
                
                this.init();
            }
            
            generateDocumentId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('doc') || 'demo-document-' + Math.random().toString(36).substr(2, 9);
            }
            
            generateUserId() {
                let userId = localStorage.getItem('bpmn-user-id');
                if (!userId) {
                    userId = 'user-' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('bpmn-user-id', userId);
                }
                return userId;
            }
            
            generateUserName() {
                let userName = localStorage.getItem('bpmn-user-name');
                if (!userName) {
                    userName = prompt('ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', 'Anonymous') || 'Anonymous';
                    localStorage.setItem('bpmn-user-name', userName);
                }
                return userName;
            }
            
            async init() {
                try {
                    this.showLoading();
                    
                    // BPMN ÌòëÏóÖ Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî (Ï†ÑÏó≠ ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö©)
                    this.editor = new window.BpmnCollaborationEditor({
                        container: '#canvas',
                        documentId: this.documentId,
                        userId: this.userId,
                        userName: this.userName,
                        serverUrl: 'ws://localhost:3000/collaboration',
                        enableCollaboration: true,
                        enablePerformanceOptimization: true,
                        enableConflictResolution: true
                    });
                    
                    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                    this.setupEventListeners();
                    
                    // Ìé∏ÏßëÍ∏∞ Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
                    this.bindEditorEvents();
                    
                    this.hideLoading();
                    this.showSuccess('BPMN Ìé∏ÏßëÍ∏∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                    
                    // URL ÏóÖÎç∞Ïù¥Ìä∏
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('doc', this.documentId);
                    window.history.replaceState({}, '', newUrl);
                    
                } catch (error) {
                    this.hideLoading();
                    this.showError('Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + error.message);
                    console.error('Initialization error:', error);
                }
            }
            
            setupEventListeners() {
                // Ìà¥Î∞î Î≤ÑÌäºÎì§
                document.getElementById('new-diagram').addEventListener('click', () => this.newDiagram());
                document.getElementById('load-diagram').addEventListener('click', () => this.loadDiagram());
                document.getElementById('save-diagram').addEventListener('click', () => this.saveDiagram());
                document.getElementById('export-svg').addEventListener('click', () => this.exportSVG());
                
                document.getElementById('start-collaboration').addEventListener('click', () => this.startCollaboration());
                document.getElementById('stop-collaboration').addEventListener('click', () => this.stopCollaboration());
                
                document.getElementById('toggle-properties').addEventListener('click', () => this.toggleProperties());
                
                // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 's':
                                e.preventDefault();
                                this.saveDiagram();
                                break;
                            case 'n':
                                e.preventDefault();
                                this.newDiagram();
                                break;
                        }
                    }
                });
            }
            
            bindEditorEvents() {
                this.editor.on('initialized', () => {
                    console.log('Editor initialized');
                });
                
                this.editor.on('collaborationConnected', ({ type }) => {
                    this.updateConnectionStatus(true);
                    this.showSuccess(`${type} ÌîÑÎ°úÎ∞îÏù¥ÎçîÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§`);
                });
                
                this.editor.on('collaborationDisconnected', ({ type }) => {
                    this.updateConnectionStatus(false);
                    this.showError(`${type} ÌîÑÎ°úÎ∞îÏù¥Îçî Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§`);
                });
                
                this.editor.on('conflictDetected', (conflict) => {
                    this.showError(`Ï∂©ÎèåÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§: ${conflict.type}`);
                });
                
                this.editor.on('conflictResolved', ({ conflict, resolution }) => {
                    this.showSuccess(`Ï∂©ÎèåÏù¥ Ìï¥Í≤∞ÎêòÏóàÏäµÎãàÎã§: ${resolution.type}`);
                });
                
                this.editor.on('error', (error) => {
                    this.showError('Ìé∏ÏßëÍ∏∞ Ïò§Î•ò: ' + error.message);
                });
                
                // CollaborationPanel Ïù¥Î≤§Ìä∏ ÏàòÏã†
                document.addEventListener('bpmn:collaborationStarted', () => {
                    this.isCollaborating = true;
                    document.getElementById('start-collaboration').style.display = 'none';
                    document.getElementById('stop-collaboration').style.display = 'inline-block';
                    this.updateConnectionStatus(true);
                });
                
                document.addEventListener('bpmn:collaborationStopped', () => {
                    this.isCollaborating = false;
                    document.getElementById('start-collaboration').style.display = 'inline-block';
                    document.getElementById('stop-collaboration').style.display = 'none';
                    this.updateConnectionStatus(false);
                });
            }
            
            async newDiagram() {
                try {
                    this.showLoading();
                    
                    const emptyDiagram = `<?xml version="1.0" encoding="UTF-8"?>
                        <bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                                         xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL"
                                         xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                                         xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                                         id="diagram_new"
                                         targetNamespace="http://bpmn.io/schema/bpmn">
                          <bpmn2:process id="Process_1" isExecutable="false">
                          </bpmn2:process>
                          <bpmndi:BPMNDiagram id="BPMNDiagram_1">
                            <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
                            </bpmndi:BPMNPlane>
                          </bpmndi:BPMNDiagram>
                        </bpmn2:definitions>`;
                    
                    await this.editor.loadDiagram(emptyDiagram);
                    this.hideLoading();
                    this.showSuccess('ÏÉà Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§');
                } catch (error) {
                    this.hideLoading();
                    this.showError('ÏÉà Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏÉùÏÑ± Ïã§Ìå®: ' + error.message);
                }
            }
            
            async loadDiagram() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.bpmn,.xml';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        this.showLoading();
                        const xml = await file.text();
                        await this.editor.loadDiagram(xml);
                        this.hideLoading();
                        this.showSuccess('Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§');
                    } catch (error) {
                        this.hideLoading();
                        this.showError('Îã§Ïù¥Ïñ¥Í∑∏Îû® Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + error.message);
                    }
                };
                
                input.click();
            }
            
            async saveDiagram() {
                try {
                    this.showLoading();
                    const xml = await this.editor.exportDiagram();
                    
                    const blob = new Blob([xml], { type: 'application/xml' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `diagram_${this.documentId}.bpmn`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.hideLoading();
                    this.showSuccess('Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÑ Ï†ÄÏû•ÌñàÏäµÎãàÎã§');
                } catch (error) {
                    this.hideLoading();
                    this.showError('Îã§Ïù¥Ïñ¥Í∑∏Îû® Ï†ÄÏû• Ïã§Ìå®: ' + error.message);
                }
            }
            
            async exportSVG() {
                try {
                    this.showLoading();
                    const svg = await this.editor.exportSVG();
                    
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `diagram_${this.documentId}.svg`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    this.hideLoading();
                    this.showSuccess('SVGÎ•º ÎÇ¥Î≥¥ÎÉàÏäµÎãàÎã§');
                } catch (error) {
                    this.hideLoading();
                    this.showError('SVG ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®: ' + error.message);
                }
            }
            
            async startCollaboration() {
                // CollaborationPanelÏùò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌòëÏóÖ ÏãúÏûë
                const panelStartBtn = document.querySelector('#panel-start-collaboration');
                if (panelStartBtn && !panelStartBtn.disabled) {
                    panelStartBtn.click();
                }
            }
            
            async stopCollaboration() {
                // CollaborationPanelÏùò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌòëÏóÖ Ï§ëÏßÄ
                const panelStopBtn = document.querySelector('#panel-stop-collaboration');
                if (panelStopBtn && !panelStopBtn.disabled) {
                    panelStopBtn.click();
                }
            }
            
            toggleProperties() {
                const panel = document.getElementById('properties-panel-container');
                panel.classList.toggle('show');
            }
            
            updateConnectionStatus(connected) {
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                if (connected) {
                    indicator.classList.add('connected');
                    text.textContent = 'Ïó∞Í≤∞Îê®';
                } else {
                    indicator.classList.remove('connected');
                    text.textContent = 'Ïó∞Í≤∞ ÏïàÎê®';
                }
            }
            
            showLoading() {
                document.getElementById('loading').classList.remove('hidden');
            }
            
            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }
            
            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.classList.add('show');
                
                setTimeout(() => {
                    errorEl.classList.remove('show');
                }, 5000);
            }
            
            showSuccess(message) {
                const successEl = document.getElementById('success-message');
                successEl.textContent = message;
                successEl.classList.add('show');
                
                setTimeout(() => {
                    successEl.classList.remove('show');
                }, 3000);
            }
        }
        
        // Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë
        document.addEventListener('DOMContentLoaded', () => {
            new AppController();
        });
    </script>
</body>
</html>